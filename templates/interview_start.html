<!DOCTYPE html>
<html>
<head>
  <title>Interview</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="card shadow-sm p-4 mb-3">
      <h3 class="mb-3">Phase-3 Interview</h3>
      <p class="mb-1"><b>Candidate:</b> {{ name }}</p>
      <p class="mb-0"><b>Scheduled Date/Time:</b> {{ interview_date or "Not set" }}</p>
    </div>

    <div class="card shadow-sm p-4 mb-3">
      <button id="startBtn" class="btn btn-primary">Start Interview</button>
      <p id="permStatus" class="text-muted mt-2 mb-0">Camera and mic permission required.</p>
      <video id="cameraPreview" class="w-100 mt-3 border rounded d-none" style="max-height: 280px;" autoplay muted playsinline></video>
    </div>

    <div id="interviewPanel" class="card shadow-sm p-4 d-none">
      <p class="text-muted mb-1">Question <span id="qNo">1</span> / <span id="qTotal">0</span></p>
      <h5 id="qText" class="mb-3"></h5>
      <textarea id="answerBox" class="form-control mb-3" rows="5" placeholder="Type your answer here..."></textarea>
      <div class="d-flex gap-2">
        <button id="submitBtn" class="btn btn-success">Submit Answer</button>
        <button id="nextBtn" class="btn btn-outline-primary">Next Question</button>
      </div>
      <div id="msg" class="mt-2 text-muted"></div>
    </div>
  </div>

  <script>
    const token = "{{ token }}";
    const questions = {{ questions|tojson }};
    const existingAnswers = {{ existing_answers|tojson }};
    const existingMonitoring = {{ monitoring|tojson }};

    let started = false;
    let currentIndex = 0;
    let questionStartTs = null;
    let tabSwitchCount = Number(existingMonitoring.tab_switch_count || 0);
    let cameraGranted = Boolean(existingMonitoring.camera_granted || false);
    let micGranted = Boolean(existingMonitoring.mic_granted || false);
    const answerMap = {};

    existingAnswers.forEach((item) => {
      if (item && typeof item.question_index === "number") {
        answerMap[item.question_index] = item.answer || "";
      }
    });

    function setMsg(text, cls) {
      const el = document.getElementById("msg");
      el.className = cls || "mt-2 text-muted";
      el.innerText = text || "";
    }

    function renderQuestion() {
      if (currentIndex >= questions.length) {
        completeInterview();
        return;
      }
      document.getElementById("qNo").innerText = String(currentIndex + 1);
      document.getElementById("qTotal").innerText = String(questions.length);
      document.getElementById("qText").innerText = questions[currentIndex];
      document.getElementById("answerBox").value = answerMap[currentIndex] || "";
      questionStartTs = Date.now();
      setMsg("", "mt-2 text-muted");
    }

    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload || {})
      });
      return await res.json();
    }

    async function updateMonitoring() {
      await postJson(`/interview/${token}/monitoring`, {
        camera_granted: cameraGranted,
        mic_granted: micGranted,
        tab_switch_count: tabSwitchCount
      });
    }

    async function submitAnswer() {
      const answer = document.getElementById("answerBox").value.trim();
      if (!answer) {
        setMsg("Please enter an answer before submitting.", "mt-2 text-danger");
        return false;
      }
      const elapsed = questionStartTs ? (Date.now() - questionStartTs) / 1000 : 0;
      const out = await postJson(`/interview/${token}/save_answer`, {
        question_index: currentIndex,
        question_text: questions[currentIndex],
        answer: answer,
        time_taken_seconds: elapsed
      });
      if (!out.ok) {
        setMsg("Could not save answer.", "mt-2 text-danger");
        return false;
      }
      answerMap[currentIndex] = answer;
      setMsg("Answer saved.", "mt-2 text-success");
      return true;
    }

    async function completeInterview() {
      await updateMonitoring();
      const out = await postJson(`/interview/${token}/complete`, {
        camera_granted: cameraGranted,
        mic_granted: micGranted,
        tab_switch_count: tabSwitchCount
      });
      if (out.ok && out.done_url) {
        window.location.href = out.done_url;
      } else {
        setMsg("Could not complete interview.", "mt-2 text-danger");
      }
    }

    document.getElementById("startBtn").addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        const preview = document.getElementById("cameraPreview");
        preview.srcObject = stream;
        preview.classList.remove("d-none");
        cameraGranted = stream.getVideoTracks().length > 0;
        micGranted = stream.getAudioTracks().length > 0;
        started = true;
        document.getElementById("permStatus").innerText = "Camera/mic permission granted.";
        document.getElementById("startBtn").disabled = true;
        document.getElementById("interviewPanel").classList.remove("d-none");
        await updateMonitoring();
        renderQuestion();
      } catch (e) {
        cameraGranted = false;
        micGranted = false;
        document.getElementById("permStatus").innerText = "Permission denied. Please allow camera and mic.";
      }
    });

    document.getElementById("submitBtn").addEventListener("click", submitAnswer);

    document.getElementById("nextBtn").addEventListener("click", async () => {
      const ok = await submitAnswer();
      if (!ok) return;
      currentIndex += 1;
      renderQuestion();
    });

    document.addEventListener("visibilitychange", () => {
      if (started && document.hidden) {
        tabSwitchCount += 1;
        updateMonitoring();
      }
    });
  </script>
</body>
</html>
