<!DOCTYPE html>
<html>
<head>
  <title>Interview</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="card shadow-sm p-4">
      <h3 class="mb-3">Interview Questions</h3>
      <p class="mb-1"><b>Candidate:</b> {{ name }}</p>
      <p class="mb-3"><b>Resume:</b> {{ resume }}</p>
      <div class="mb-3">
        <video id="cameraPreview" class="w-100 rounded border" style="max-height:240px;" autoplay muted playsinline></video>
      </div>
      <div class="alert alert-secondary py-2">
        Keep this tab active and fullscreen during interview.
      </div>

      {% if questions and questions|length > 0 %}
      <ol class="mb-0">
        {% for q in questions %}
        <li class="mb-2">
          {% if q is mapping %}
            {{ q.get("question", "") }}
          {% else %}
            {{ q }}
          {% endif %}
        </li>
        {% endfor %}
      </ol>
      {% else %}
      <div class="alert alert-secondary mb-0">No questions available.</div>
      {% endif %}
    </div>
  </div>
  <script>
    const token = "{{ token }}";

    async function postProctorEvent(eventType, details) {
      try {
        await fetch(`/proctor_event/${token}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            event_type: eventType,
            details: details || {},
            client_ts: new Date().toISOString()
          })
        });
      } catch (_) {
      }
    }

    async function requestCameraPermission() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        postProctorEvent("camera_not_supported", { ua: navigator.userAgent });
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        const preview = document.getElementById("cameraPreview");
        preview.srcObject = stream;
        postProctorEvent("camera_permission_granted");
      } catch (err) {
        postProctorEvent("camera_permission_denied", { message: err && err.message ? err.message : "denied" });
      }
    }

    document.addEventListener("visibilitychange", function () {
      if (document.hidden) {
        postProctorEvent("tab_hidden");
      } else {
        postProctorEvent("tab_visible");
      }
    });

    document.addEventListener("fullscreenchange", function () {
      if (!document.fullscreenElement) {
        postProctorEvent("fullscreen_exit");
      }
    });

    window.addEventListener("load", function () {
      requestCameraPermission();
    });
  </script>
</body>
</html>
